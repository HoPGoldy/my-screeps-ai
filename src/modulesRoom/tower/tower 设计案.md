# tower 设计案（已实装）

tower 分为日常模式和战时（主动防御）模式

# 日常模式工作流程

- 每 5tick 都会搜索距离最近的敌人，优先级最高，一旦发现敌人直接攻击直至房间内不存在敌人
    - 如果敌人是白名单中的玩家，将不会进行攻击。
- 每隔一段时间搜索受损建筑并维修
- 每隔一段时间搜索未达标围墙并维修，并且在能量低于 500 时跳过该阶段

# 什么是未达标围墙？

在房间的内存中拥有如下属性：

```js
// 当前正在关注的墙
focusWall: {
    // 墙的 id
    id: '18s8d6g6bx88sa0a',
    // 关注的结束时间
    endTime: 122289
}
```

该属性描述了一个被关注的墙（wall 和 rempart）。tower 每隔一段时间都会检查一下该属性，如果当前时间已经大于了关注的结束时间，则重新搜索房间中生命值最低的墙，并写入 id 以及将 endTime 置为 100 tick 之后。

而如果当前时间小于关注结束时间，将直接维修该墙。

**注意**：builder 在修建新的 rempart 时会移除该属性（强制刷新，让 tower 可以立刻发现新的 rempart）。

# 基本缓存优化

敌人搜索和受损建筑搜索都使用非持久缓存来减少相同房间内的搜索消耗。

- 敌人搜索：`room._enemys`
- 受损建筑：`room._damagedStructure`

# 性能预估

该方案必定会增大能量的损耗，但是相应的节省了 creep 的寻路消耗、移动消耗并减少了 creep 的数量。tower 效果随距离衰减也可以变相的看做 cpu 的浪费，但是其消耗和 creep 刷墙的消耗并不好衡量。本项目将采取日常 tower 刷墙，战时 creep 刷墙的模式。

# 主动防御

主动防御是指房间的 tower 防御机制无法有效的消灭敌人时孵化 creep 进行反击和增强维修的功能。

## 模式切换（日常 > 主动）

房间内的敌人总身体部件超过 50（超过一个满配 creep）

如果敌人是 npc 入侵者则不会切换状态

## 主动模式

下列步骤将会依次进行

- tower 停止刷墙工作。
- 房间进入战争状态，通知 manager 搬运强化化合物。
- 发布维修工，主动维修受到攻击的墙体。
- 化合物搬运完成后发布 Defender 单位，主动进攻敌人。
- Defender 孵化完成后 tower 将治疗 Defender 置为优先目标。

## 模式切换（主动 > 日常）

- Defender 老死

满足以上条件则切换至日常模式并解除战争状态
