# 房间物流任务模块

房间物流是指处理房间以内的资源转移任务，由 manager 角色负责。

## 物流任务

一个物流任务由多个请求构成，每个请求的格式如下：

- `from` 从哪：【可选】为空时默认从 storage、terminal 里取，支持传入 id 或者一个 pos、或者一个 structureType 数组
- `to` 搬到哪：必填，可以传入 id 或者一个 pos，或者一个建筑类型
- `resType` 搬什么：必填，一个资源类型
- `amount` 搬多少：【可选】为空时将一直搬运，直到目标建筑满了或者来源建筑空了

**为什么要设计成一个任务嵌套多个请求，而不是直接把请求平铺放在任务队列里？**

请求直接放在任务队列里其实是更简洁的，但是需要付出额外的“聚合”计算消耗，比如，有那些一次只拿几个的请求，这时需要检查有没有同目标的其他请求，有的话就可以一次性多带点。如果请求直接放在任务队列里，就需要一些代码实现 **“把请求按照同源同目标的规则进行分组”**，来提高搬运效率。

但是如果我们发布任务的时候天生携带这种“聚合”关系（可以直接假定每个任务里的请求都是同源同目标的），就不再需要上面这部分的计算消耗。

*并且，由于任务队列会经常处理“是否存在某个任务”这种搜索请求，如果直接把物流物流请求放在任务队列里。就会导致搜索消耗增大。*

## 多 creep 处理同一任务时的问题

### 1、资源重复搬运

**问题**：两个爬同时处理一个物流请求，最后导致搬到目标两倍的数量。

**解决**：每个物流请求会有两个额外字段，保存当前正在处理这个请求的爬名字和已经搬完了多少数量。

爬在挑选物流请求的时候会优先挑选没有处理者的请求。当所有请求都有人处理的时候，会进行“饱和式”搬运，不过在放到目标地方的时候会检查已经搬完了多少数量，避免放下过多的资源。

### 2、过早结束

**问题**：由于任务爬访问不到同时处理该任务的其他爬。所以有可能会出现：一个爬发现某种需要搬运的资源没有了，然后请求结束任务。但是这些资源可能已经被另一个爬拿走正在搬运了。这时请求结束任务会导致这个正在搬运的爬干着干着突然活没了，最后不知道该咋办。

**解决**：结束任务时不是直接结束，而是提交给管理模块“申请”结束，管理模块统一检查，把申请结束的爬调到其他任务上，然后看一下这个任务还有没有其他爬在干活了，没有的话才会真正结束。