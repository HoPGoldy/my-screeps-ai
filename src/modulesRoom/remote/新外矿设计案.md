# 新外矿模块（未实装）

这里所说的“外矿”是指位于非己方房间内的 **单个 source**。外矿采集模式分为基础模式和完整模式。

**基础模式**：主要用于主房等级较低的时期，不会在外矿建立道路、container 等基础设施（因为主房没法提供保护），creep 采集完能量后会自己带回来。当外矿被入侵（npc、core、玩家控制）时，将会直接放弃该外矿房间，并在未来尝试重新启用外矿。

**完整模式**：会在外矿房间中修建道路和 container，在能量采集达到上限后会请求孵化预定单位，并在外矿被入侵后请求主房孵化战斗单位进行防御。当防御失败（没打过）时将放弃外矿，并在未来尝试重新启用。

## 相关角色

**采集单位 RemoteHarvester**：采集能量，在简单模式下会直接运输到主房间，在完整模式下会修建 container 并无脑采集能量。

**运输单位 RemoteTransporter**：一对一运输，从采集单位下的 container 中获取能量，搬运回房间，仅在完整模式下才会孵化。

**预定单位 reserver**：紫球，用于预定房间，在房间首次采集到 source 上限时孵化。

**防御单位 defender**：篮球，用于抵抗房间中存在的入侵者，在房间中有 core 时也会进行拆除。

**核心拆除单位 CoreHandler**：红球，用于专门拆除房间中的 core，在拆除完成后会访问地图库，并拆除相邻房间中的 core。

## 接口

- 对外暴露（其他模块或者玩家）
    - 新增外矿（目标房间，sourceId，是否为完整模式）
    - 暂停外矿（sourceId）
    - 移除外矿（sourceId）
    - 显示所有外矿状态
    - 更新外矿模式（sourceId）

- 对内暴露（执行采集的单位）
    - 请求预定单位
    - 请求拆除 core
    - 请求防御
    - 获取外矿信息

## 储存

每个外矿的内存配置项

```typeScript
{
    // 外矿所在房间名
    room: string
    // 要采集的 source id
    sourceId: Id<Source>
    // 要存放到的目标建筑 id，优先使用
    targetId?: Id<StructureWithStore>
    // 要把能量运输到的目标位置，targetId 不存在时使用
    targetPos?: RoomPosition
    // 是否启用完整外矿
    complete?: boolean
    // 是否需要孵化预定单位
    needReserver?: boolean
    // 该外矿是否暂停
    pause?: boolean
}
```

## 流程

- 添加新外矿
    - 根据房间可用能量判断是基础模式还是完整模式
    - 如果是基础模式
        - 孵化采集单位前往
        - 采集完成后返回家里并存放
    - 如果是完整模式
        - 孵化采集单位前往
        - 采集并修建 container
        - 修建完成后发布外矿运输单位
        - 外矿运输单位从 container 中获取能量并修路

- 发现敌人
    - 如果是基础模式
        - 通知主房间，关闭外矿并延迟 1500t 后重新启用外矿
    - 如果是完整模式
        - 采集单位收到攻击后会搜索房间查找敌人
        - 通知主房间，关闭外矿并延迟 1500t 后重新启用外矿
        - 检查敌人是否打得过
            - 若打不过，则啥都不干，等待老死
            - 若打得过，孵化防御单位进行攻击
                - 成功击杀入侵者，直接重启外矿
                - 被入侵者击杀，啥都不干，等待入侵者老死

- 更新外矿模式
    - 更新房间内存数据，等到下个采集单位孵化后重新应用