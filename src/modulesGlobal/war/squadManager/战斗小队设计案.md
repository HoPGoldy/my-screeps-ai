# 战斗小队设计案（设计阶段）

使用策略模式对战斗小队模块进行封装，以此来实现对多套小队逻辑的兼容性：

|层级|角色|介绍|
|:-:|:-:|:-:|
调用层|**`Creep` 战斗角色**|调用小队模块，根据自己需要发起组队和解散请求。并根据自身状态选择执行自己的行为逻辑还是执行小队逻辑。
框架层|**`BattleFrame` 小队战斗框架**|负责实现通用的战斗流程及一些可复用的寻路/动作逻辑，并根据 creep 的小队类型执行指定的小队逻辑。
策略层|**`SquadStrategy` 小队逻辑**|可以同时存在多套以应对不同种类的四人小队，如四人一体机、两黄球两绿球、两绿球一黄一红等小队，封装了无法复用到其他小队的战时逻辑，被战斗框架调用。

# 基础原则

- 小组模块没有主动执行的能力，需要由 Creep 调用，然后该模块才会去获取整个小组的状态并执行小队逻辑。
- 模块发现有队友缺失时会解散小队，之后需要小队成员重新发起组队。
- 小组的信息保存在全局，在解散小队时移除。
- 不包含角色孵化及 boost 等非战斗逻辑，防止过度耦合。

# 流程

*[] 中的是当前执行的代码角色*

- **[creep]** 检查内存，确认自己是否在小队中
- **[creep]** 发现不在小队中，请求小队模块组建小队
- **[小队模块]** 检查房间中友方非小队 Creep，调出符合条件的组建小队
    - 如果组建成功，更新小队成员内存状态，return 组建成功
    - 没找到合适的人则 return 组建失败
- **[creep]** 检查组建结果
    - 组建失败，执行单体行动逻辑
    - 组件成功，调用小队模块行动逻辑
- **[小队模块]** 被调用
    - 检查有没有同队成员进行过调用，有就 return 出去（一个小队每 tick 只会执行一次）
    - 根据传入的小队类型加载对应的小队逻辑（`SquadStrategy`）
    - 在通用框架的指导下调用 `SquadStrategy` 中定义好的方法。

# `BattleFrame` 小队战斗框架

- 执行小队活动

    通过 creep 内存中的小队字段进行调用，每个小队每 tick 仅执行一次调用。该操作是战争框架的入口。会通过 `SquadStrategy` 来指导 creep 在房间中的行为。

- 组建小队

    Creep 请求组队，会查找房间中的友方 Creep 进行组队。

- 路径查找

    通过房间状态决策行动路线，房间状态包括地形、建筑、敌方 creep 实力、友方 creep 位置等，最终叠加到 cost 上来影响寻路。

- 按路径移动

    整个小队按照规划好的路径进行移动

- 方向检查

    当小队方向和目标方向不一致时执行小队动作来更正方向

- 执行小队动作

    执行例如：转向、左转、右转、反向等行动

- 解散小队

    解散小队，将成员恢复为一体机状态（小队成员死亡时执行）

- 小队前进至指定房间

    让组建完成的小队前进至指定房间

# `SquadStrategy` 小队策略

- 成员构成

    本小队需要哪些角色，各需要几个，在小队集结时由战斗框架读取

- 战术动作

    由于小队和小队之间的队形不同，所以在执行战术动作时的具体换位也不同，这里包含了具体动作的队员换位规则。

- 队形检查（接受：小队 creep 数组，返回：boolean）

    检查小队队形是否正常，是否需要重新集合。

- 集结小队

    让不处于正常队形（被挤开或者散开）的小组成员重新集结为需要的队形

- 小队指令 - 攻击 Creep

    搜索攻击范围内是否有敌人，有则执行攻击策略

- 小队指令 - 攻击 Structure

    向缓存中的敌方建筑发起攻击，没有缓存就进行查找

- 小队指令 - 治疗

    检查当前小队生命状态，并根据其执行治疗策略

- 寻路回调（接受：房间名和 CostMatrix，返回：新的 CostMatrix）

    应用在 `BattleFrame` 的寻路中，为本小队添加自定义 cost

- 决定移动策略（接受：前面三个小队指令指定返回值，返回：boolean）

    根据小队指令的返回值决定小队是前进还是逃跑，该方法会影响 `BattleFrame` 的寻路