# 移动及寻路设计案

该模块包含了 creep 和 powerCreep 的移动及通用寻路逻辑。

## 简介

creep 在开始移动时进行寻路（不搜索其他 creep），在移动时撞到了 creep 就进行对穿，撞到了墙就重新寻路。支持以下功能：

- 快速设置是否禁止/允许对穿
- 路径点移动
- 跨 shard 移动

## 对穿

在移动时保存上个位置，并在移动之后拿当前位置进行对比，如果位置相同就说明发生了“撞停“。发生撞停后会根据原本前进方向找到下个 RoomPosition，然后检查这个位置上是否有自己的 creep。如果没有，则重新规划寻路。如果有的话，向目标 creep 发起对穿请求，如果对方同意，则进行对穿。否则重新寻路。

## 路径点

如同红警、星际中的路径点一样，该功能可以使 creep 完成更复杂的远程寻路，creep 会先把第一个路径点当作寻路终点，抵达后在进行下一个寻路。在跨 shard 时这个功能尤为重要。可以通过将不同传送门配置成路径点的形式来完成在多个 shard 间跳跃。

路径点支持以下两种形式的配置：

- **位置字符串数组**：传入一个形如 `[ '12 21 E1N1', '12 21 E2N2', '12 21 E3N3' ]` 的字符串数组。
- **路劲点旗帜**：传入一个旗帜前缀，如：`waypoint`。creep 会自动寻找 `waypoint1` 的旗帜当作第一个路径点，抵达后自动寻找 `waypoint2` 并移动 ...，直到找不到相同格式的旗帜为止。 

## ~~禁止通行点位~~

已废弃，使用对穿规则代替

**废弃原因**

- **高耦合，低内聚**：禁止通行点位分为内存中的 `stand` 字段和房间内存中的 `restrictedPos`，而这两者并没有较为紧密的联系，例如为了节省性能，禁止点位一般都是在刚开始站定（`stand = true`）工作时添加，而此后 creep 依旧可以进行移动，这时就会出现，虽然申请了禁止点位，但是 creep 的位置和这个禁止点位实际上并不一致，由此就导致了寻路问题。

- **低灵活度**：没有办法进行细粒度的配置，例如这个需求：`repairer` 在刷墙时可能会站在道路上，我想让它在工作时禁止同角色的 creep 对穿，而又允许 `filler` 之类的运输单位对穿。而禁止通行点位只能非黑即白的进行禁止 / 允许的绕过判定。

**目的**

由于在工作中的 creep 会保持不动（例如 upgradeController），而此时如果有其他 Creep 发起对穿的话会使得它的工作返回 ERR_NOT_IN_RANGED，然后再对穿回来，就导致了两个 Creep 为了争夺工作位置一直对穿。为了解决该问题，引入了“禁止通行点位”概念。

该概念是指，在工作时的 creep 会将自己的位置设置为不可通行，得其他 creep 在寻路时会直接跳过该位置。并且，在工作时的 creep 也将拒绝对穿，从而避免了争抢工作位置的事情发生。

**申请禁止通行点位**

通过 `Room.addRestrictedPos()` 方法来申请一个禁止通行点位，申请点位需要申请 creep 的名字。

**获取禁止通行点位**

creep 在寻路时会自动调用 `Room.getRestrictedPos()` 来获取禁止通行点位，并进行绕过。

**释放禁止通行点位**

通过 `Room.removeRestrictedPos()` 来释放点位，释放点位只需要传入点位申请人的名字即可。

## 对穿规则

位于 `/src/modules/move/crossRules.ts` 中。

对穿规则解决了禁止通行点位的问题，它是由一组函数组成，这组函数接受被对穿 creep 和请求对穿的 creep，并返回是否允许对穿。

在 **寻路** 和 **响应对穿** 时，会去访问与自己角色相对应的规则（没有则访问默认规则），并根据该规则的返回值决定是否可以对穿或者在寻路时绕过。

**性能对比**

- 禁止通行点位会占用 memory，导致操作和解析开销，而对穿规则只是简单的 creep 内存字段比较，不会把结果存到内存中。
- 使用了禁止通行点位时的寻路依旧需要进行 `room.find` 来查找 creep 来完成一些绕过禁用对穿的 creep 和绕过非己方 creep。在这一点上对穿规则不会带来更多的消耗。

## 概念 - 站定

当一个 creep 因为某些需要而站立不动时，我们称其为 “站定” 状态。例如一个 worker 站定刷墙，一个 upgrader 站定升级，一个 harvester 站定采集 source。

某些 creep 在站定时不允许对穿（如 harvester），而某些单位在站定时允许部分角色对穿（upgrader 在升级时允许搬运工对穿，但是不允许其他 upgrader 对穿）