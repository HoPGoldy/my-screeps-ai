# tower 优化案（已实装）

# 目标

- tower 承担刷墙工作
- 彻底移除 towerTransfer 角色
- 在后期（有了 transfer 之后）移除 repairer 角色

# 修改

**repairer** 

- 在没有 tower 之前依旧是有损坏的建筑的就修，没有就刷墙，在有了 tower 之后将专职给 tower 充能

**tower**

- 每 5tick 都会搜索距离最近的敌人，优先级最高，一旦发现敌人直接攻击
    - 如果敌人是白名单中的玩家，将不会进行攻击。
- 每隔一段时间搜索受损建筑并维修
- 每隔一段时间搜索未达标围墙并维修，并且在能量低于 500 时跳过该阶段

# 什么是未达标围墙？

在房间的内存中拥有如下属性：

```js
// 当前正在关注的墙
focusWall: {
    // 墙的 id
    id: '18s8d6g6bx88sa0a',
    // 关注的结束时间
    endTime: 122289
}
```

该属性描述了一个被关注的墙（wall 和 rempart）。tower 每隔一段时间都会检查一下该属性，如果当前时间已经大于了关注的结束时间，则重新搜索房间中生命值最低的墙，并写入 id 以及将 endTime 置为 100 tick 之后。

而如果当前时间小于关注结束时间，将直接维修该墙。

**注意**：builder 在修建新的 rempart 时会移除该属性（强制刷新，让 tower 可以立刻发现新的 rempart）。

# 基本缓存优化

敌人搜索和受损建筑搜索都使用非持久缓存来减少相同房间内的搜索消耗。

- 敌人搜索：`room._enemys`
- 受损建筑：`room._damagedStructure`

# 性能预估

该方案必定会增大能量的损耗，但是相应的节省了 creep 的寻路消耗、移动消耗并减少了 creep 的数量。tower 效果随距离衰减也可以变相的看做 cpu 的浪费，但是其消耗和 creep 刷墙的消耗并不好衡量。本项目将采取日常 creep 刷墙，战时 creep 刷墙的模式。