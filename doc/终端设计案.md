# 终端设计案（以实装）

## 需求

- 保持房间中指定矿物的数量
- 可以卖出指定货物
- 可以快捷的向其他房间发送矿物

## 操作

- 添加监听矿物
- 移除监听矿物
- 查看监听列表

## 规则

- 每 10 tick 执行一次，并且仅在冷却完成后才开始工作 [节省 cpu]
- 存有一个索引，遇到下述情况时将索引指向下一个监听矿物 [保证所有矿物都可以被处理]
    - 监听的矿物符合期望后
    - 不符合期望的矿物没有找到合适的订单

## 监听规则

监听规则分为三种，`max`、`min` 和 `all`：

- max：只在被监听的矿物超出设置的数量时才触发**卖出**操作
- min：只在被监听的矿物低于设置的数量时才触发**补货**操作
- all: 双向都会触发，会将矿物的值始终维持在固定值（默认）

补货操作分为两种，房间资源共享和买入：

- 房间资源共享：发现指定矿物数量不足时会想资源共享控制器申请资源
- 买入：发现指定矿物数量不足时会从市场上买入（默认）

## 前提

- 所有元素矿及化合物都储存在终端里
- storage 里有能量可以使用

## 流程（过期）

- 10 tick 检查，冷却检查
- 检查有没有之前保存的订单 id
    - 有，检查路费是不是足够？
        - 不足，return
        - 足够，统计要购买/卖出的数量，deal 订单并检查返回值
            - 返回值正常，移除缓存的订单 id，索引 + 1
            - 返回值不正常，发邮件通知，索引 + 1
- 检查监听列表和索引，找到要检查的矿物
- 检查库存里的矿物是不是符合期望
    - 符合期望，索引 + 1，return
    - 不符合期望，是多了还是少了
        - 多了，去查找买单
        - 少了，去查找卖单
    - 有没有合适的订单？
        - 有，订单 id 写入缓存，检查所需能量，向 centerTransfer 要路费，return
        - 没有，索引 + 1，return
